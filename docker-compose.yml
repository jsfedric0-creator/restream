version: '3.8'

services:
  app:
    build: .
    ports:
      - "8080:80"
      - "8000-8100:8000-8100"  # For stream proxying
    environment:
      - DB_HOST=db
      - DB_NAME=iptv_panel
      - DB_USER=iptv_user
      - DB_PASS=${DB_PASSWORD}
      - ADMIN_USER=admin
      - ADMIN_PASS=${ADMIN_PASSWORD}
      - APP_SECRET=${APP_SECRET}
      - APP_URL=${APP_URL}
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./config.php:/var/www/html/config.php
      - ./index.php:/var/www/html/index.php
      - ./login.php:/var/www/html/login.php
      - ./streams.php:/var/www/html/streams.php
      - ./api.php:/var/www/html/api.php
      - ./style.css:/var/www/html/style.css
      - stream_cache:/tmp/stream_cache
    depends_on:
      - db
    restart: unless-stopped
    networks:
      - iptv-network

  db:
    image: mysql:8.0
    environment:
      - MYSQL_ROOT_PASSWORD=${DB_ROOT_PASSWORD}
      - MYSQL_DATABASE=iptv_panel
      - MYSQL_USER=iptv_user
      - MYSQL_PASSWORD=${DB_PASSWORD}
    volumes:
      - mysql_data:/var/lib/mysql
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    command: >
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
      --max_connections=1000
    networks:
      - iptv-network

networks:
  iptv-network:
    driver: bridge

volumes:
  mysql_data:
  stream_cache:
