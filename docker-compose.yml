version: '3.8'

services:
  app:
    build: .
    ports:
      - "8080:80"
      - "8000-8050:8000-8050"  # More ports for auto streams
    environment:
      # Database (Your InfinityFree)
      - DB_HOST=sql213.infinityfree.com
      - DB_PORT=3306
      - DB_NAME=if0_40139753_syriatv
      - DB_USER=if0_40139753
      - DB_PASS=mbxTQ8Wpba50L
      
      # Admin
      - ADMIN_USER=admin
      - ADMIN_PASS=${ADMIN_PASSWORD:-SyriaTV@2024}
      - APP_SECRET=${APP_SECRET:7338845672754}
      - APP_NAME=SyriaTV Auto Restream
      - APP_URL=${APP_URL}
      
      # Auto Configuration
      - AUTO_DISCOVER=true
      - AUTO_RESTART=true
      - AUTO_CHECK_INTERVAL=60
      - AUTO_MAX_STREAMS=50
      - AUTO_M3U_URLS=${M3U_URLS}
      - AUTO_COUNTRIES=SY,SA,AE,QA,EG,LB,JO
      - AUTO_CATEGORIES=News,Sports,Entertainment,Movies,Kids,Religion
      
      # Monitoring
      - MONITOR_ENABLED=true
      - MONITOR_TELEGRAM_BOT=${TELEGRAM_BOT_TOKEN}
      - MONITOR_TELEGRAM_CHAT=${TELEGRAM_CHAT_ID}
      - ALERT_DOWNTIME_MINUTES=5
      
      # Performance
      - STREAM_TIMEOUT=30
      - STREAM_BUFFER=4096
      - MAX_CONNECTIONS=100
      - CACHE_TTL=300
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./supervisord.conf:/etc/supervisor/conf.d/supervisord.conf
      - .:/var/www/html
      - stream_cache:/tmp/stream_cache
      - stream_logs:/var/log/streams
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health.php"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  stream_cache:
  stream_logs:
